name: Update Gacha Data

on:
  schedule:
    # 每周五晚上8点和9点运行
    - cron: '0 20 * * 5'
    - cron: '0 21 * * 5'
    # 每周六早上8点运行
    - cron: '0 8 * * 6'
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update Genshin Impact gacha data
        run: |
          python -c "
          from app import fetch_genshin_gacha_data
          import json
          data = fetch_genshin_gacha_data()
          with open('genshin/gacha_data.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          print('Updated Genshin Impact gacha data')
          "

      - name: Update Honkai Star Rail gacha data
        run: |
          python -c "
          from app import fetch_hsr_wish_data
          import json
          data = fetch_hsr_wish_data()
          with open('hsr/gacha_data.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          print('Updated Honkai Star Rail gacha data')
          "

      - name: Update Zenless Zone Zero gacha data
        run: |
          python -c "
          from app import get_zzz_gacha_data
          import json
          data = get_zzz_gacha_data()
          with open('zzz/gacha_data.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          print('Updated Zenless Zone Zero gacha data')
          "

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --name-only | grep -E 'genshin/gacha_data.json|hsr/gacha_data.json|zzz/gacha_data.json'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes to GitHub
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add genshin/gacha_data.json hsr/gacha_data.json zzz/gacha_data.json
          git commit -m "Update gacha data $(date +'%Y-%m-%d')"
          # 拉取最新代码并变基，然后推送到 GitHub 原仓库
          git pull --rebase origin main
          git push origin main

      - name: No changes to commit on GitHub
        if: steps.check_changes.outputs.changes == 'false'
        run: echo "No changes to commit on GitHub"

      # ---------- 推送至 Gitee 的正确方法（已修正）----------
      - name: Check Gitee Token
        id: check_gitee_token
        run: |
          if [ -z "${{ secrets.GITEE_TOKEN }}" ]; then
            echo "gitee_token_set=false" >> $GITHUB_OUTPUT
          else
            echo "gitee_token_set=true" >> $GITHUB_OUTPUT
          fi

      - name: Push to Gitee (with or without changes)
        if: steps.check_gitee_token.outputs.gitee_token_set == 'true'
        env:
          # 将 Token 放入环境变量，避免在命令行中直接显示
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # 关键修正：使用 https://用户名:令牌@仓库地址 格式
          # 这里用户名固定为 gitee，密码使用 secrets.GITEE_TOKEN
          GITEE_URL="https://gitee:${GITEE_TOKEN}@gitee.com/zisekongling/gacha-tracker.git"
          
          # 强制推送到 Gitee 的 main 分支（与你 GitHub 主分支一致）
          git push -f "${GITEE_URL}" main
          echo "Successfully force-pushed to Gitee repository"

      - name: Gitee Token not set
        if: steps.check_gitee_token.outputs.gitee_token_set == 'false'
        run: echo "Gitee Token is not set, skipping push to Gitee"
